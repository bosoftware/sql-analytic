<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>SQLODataService UI</title>
<link rel="stylesheet" type="text/css" href="css/style.css">
<script type="text/javascript" src="js/util.js"></script>
<script type="text/javascript" src="js/metadata.js"></script>
<script type="text/javascript" src="js/service.js"></script>
</head>
<body>
	<script type="text/javascript" id="buildMenu">
			function resetOptions(){
			    window.$queryOptions = {
			    	$top:20,	
			    	$skip:0,
			    	$select:"*"
			    };
			}
			resetOptions();
			window.$metadata = new ServiceMetadata(
				"http://localhost:8080/sql-odata-web/SQLODataService.svc",
				function(metadata) {
					var list = "<ul>";
					for (e in metadata.entitySets) {
						var handler = "selectEntitySet('{0}')".format(e);
						list += "<li><a href=\"#\" onClick=\"{0}\">{1}</a></li>"
								.format(handler, e);
					}
					list += "</ul>";
					var menu = document.getElementById("menu");
					menu.innerHTML = list;
					window.$service = new Service($metadata);
				});
	</script>
	<script type="text/javascript" id="buildDataTable">
	   function selectEntitySet(eSetName){
		   resetOptions();
		   buildDataTable(eSetName)
	   }
	
		function buildDataTable(eSetName) {			
			$service.getEntitySet(eSetName,$queryOptions, function(data, entityType) {
				var entities;
				if(data.value === undefined){					
					entities = new Array(data);
				}else {
					entities = data.value;
				}
				var dataTable = "<table><thead><tr>";
				var colCount = 0;
				for (p in entityType.properties) {
					dataTable += "<th>{0}</th>".format(p);
					colCount++;
				}
				dataTable += "</thead></tr><tbody>";
				for (var i in entities) {
					var row = entities[i];
					var key = {};
					for(var k in entityType.keys){
						key[entityType.keys[k]] = row[entityType.keys[k]];  
					}
					var keyJson = JSON.stringify(key).replace(/["]/g,"&quot;");
					var selectRow = "onClick=\"selectRow('{0}',{1})\"".format(eSetName,keyJson);
					
					if (i % 2 == 1) {
						dataTable += "<tr {0}>".format(selectRow);
					} else {
						dataTable += "<tr class=\"alt\" {0}>".format(selectRow);
					}
					for (col in entityType.properties) {
						dataTable += "<td>{0}</td>".format(row[col]);
					}
					dataTable += "</tr>";
				}
				dataTable += "</tbody>";
				dataTable += document.getElementById("dataTableFoot").
				innerHTML.
				format(colCount,eSetName,++i) ;
				
				dataTable += "</table>";
				document.getElementById("dataTable").innerHTML = dataTable;
			});
		}
	</script>
	<script type="text/javascript" id="nextPage">
	 
	   function nextPage(eSetName,count){
		   if(count == $queryOptions.$top){
		    $queryOptions.$skip = $queryOptions.$skip + $queryOptions.$top;
		   }	      
		   buildDataTable(eSetName);
	   }
	 
	</script>
	<script type="text/javascript" id="previousPage">
	 
	   function previousPage(eSetName){
		   var skip = $queryOptions.$skip - $queryOptions.$top;
		   $queryOptions.$skip = skip < 0 ? 0 : skip;
		   buildDataTable(eSetName);
	   }
	 
	</script>
	<script type="text/javascript" id="selectRow">
		function selectRow(eSetName,key){
			$queryOptions.key = key; 
			buildDataTable(eSetName);
		}
	</script>
	
	<script type="text/template" id="dataTableFoot">
	<tfoot>
		<tr>
			<td colspan="{0}">
				<div id="paging">
					<ul>
						<li><a href="#" onClick="previousPage('{1}')"><span>Previous</span></a></li>						
						<li><a href="#" onClick="nextPage('{1}',{2})" ><span>Next</span></a></li>
					</ul>
				</div>
		</tr>
	</tfoot>
	</script>

	<div id="menu"></div>
	<div id="dataTable" class="datagrid"></div>

</body>
</html>
